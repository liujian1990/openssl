Description: fix negotiate not treated as connection-oriented
Origin: backport, https://github.com/bagder/curl/commit/f78ae415d24b9bd89d6c121c556e411fdb21c6aa
Origin: backport, https://github.com/bagder/curl/commit/79b9d5f1a42578f807a6c94914bc65cbaa304b6d

Index: curl-7.35.0/lib/http.c
===================================================================
--- curl-7.35.0.orig/lib/http.c	2015-04-22 08:45:34.520218581 -0400
+++ curl-7.35.0/lib/http.c	2015-04-22 08:45:55.408396962 -0400
@@ -1413,6 +1413,18 @@
 
   Curl_unencode_cleanup(conn);
 
+#ifdef USE_HTTP_NEGOTIATE
+  if(data->state.proxyneg.state == GSS_AUTHSENT ||
+     data->state.negotiate.state == GSS_AUTHSENT) {
+    /* add forbid re-use if http-code != 401/407 as a WA only needed for
+     * 401/407 that signal auth failure (empty) otherwise state will be RECV
+     * with current code */
+    if((data->req.httpcode != 401) && (data->req.httpcode != 407))
+      conn->bits.close = TRUE;
+    Curl_cleanup_negotiate(data);
+  }
+#endif
+
   /* set the proper values (possibly modified on POST) */
   conn->fread_func = data->set.fread_func; /* restore */
   conn->fread_in = data->set.in; /* restore */
Index: curl-7.35.0/lib/http_negotiate.c
===================================================================
--- curl-7.35.0.orig/lib/http_negotiate.c	2015-04-22 08:45:34.520218581 -0400
+++ curl-7.35.0/lib/http_negotiate.c	2015-04-22 08:45:34.520218581 -0400
@@ -355,7 +355,6 @@
   }
 
   Curl_safefree(encoded);
-  Curl_cleanup_negotiate(conn->data);
 
   return (userp == NULL) ? CURLE_OUT_OF_MEMORY : CURLE_OK;
 }
Index: curl-7.35.0/lib/http_negotiate_sspi.c
===================================================================
--- curl-7.35.0.orig/lib/http_negotiate_sspi.c	2015-04-22 08:45:34.520218581 -0400
+++ curl-7.35.0/lib/http_negotiate_sspi.c	2015-04-22 08:45:34.520218581 -0400
@@ -268,7 +268,6 @@
   else
     conn->allocptr.userpwd = userp;
   free(encoded);
-  Curl_cleanup_negotiate (conn->data);
   return (userp == NULL) ? CURLE_OUT_OF_MEMORY : CURLE_OK;
 }
 
